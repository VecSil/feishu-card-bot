# 飞书多维表格MBTI名片生成系统部署指南

## 📋 概述

本指南将帮助你完成飞书多维表格与MBTI名片生成系统的完整集成，实现：
- ✅ 用户填写问卷数据自动生成个性化名片  
- ✅ 名片自动发送到用户私聊
- ✅ 名片链接自动更新到多维表格
- ✅ 完整的工作流程自动化

## 🎯 最终效果

用户体验流程：
1. 在飞书多维表格中填写MBTI问卷信息
2. 点击"生成名片"按钮（或自动触发）
3. 系统自动生成个性化名片
4. 用户立即收到私聊消息（包含名片图片）
5. 多维表格中自动更新名片链接和状态

## 📊 第一步：多维表格字段配置

### 1.1 创建基础信息字段

在你的多维表格中创建以下字段：

| 字段名 | 字段类型 | 必填 | 说明 |
|--------|----------|------|------|
| 昵称 | 单行文本 | ✅ | 用户显示名称 |
| 性别 | 单选 | ❌ | 选项：男/女/保密 |
| 职业 | 单行文本 | ❌ | 用户职业信息 |
| 兴趣爱好 | 多行文本 | ❌ | 兴趣爱好或项目方向 |
| MBTI类型 | 单选 | ✅ | 16种MBTI类型选项 |
| 一句话介绍 | 多行文本 | ❌ | 个人介绍 |
| 微信二维码 | 附件 | ❌ | 用户上传的微信二维码 |

### 1.2 创建结果字段

| 字段名 | 字段类型 | 说明 |
|--------|----------|------|
| 名片图片 | URL | 存储生成的名片访问链接 |
| 图片标识 | 单行文本 | 存储飞书image_key |
| 生成状态 | 单选 | 选项：待生成/生成中/✅已完成/❌失败 |
| 生成时间 | 日期时间 | 名片生成时间戳 |
| 本地备份 | URL | 本地文件备用链接（可选） |

### 1.3 MBTI类型单选选项配置

创建"MBTI类型"单选字段时，添加以下16个选项：

**分析师（NT）：**
- INTJ - 建筑师
- INTP - 思想家  
- ENTJ - 指挥官
- ENTP - 辩论家

**外交家（NF）：**
- INFJ - 提倡者
- INFP - 调停者
- ENFJ - 主人公
- ENFP - 竞选者

**守护者（SJ）：**
- ISTJ - 物流师
- ISFJ - 守护者
- ESTJ - 总经理
- ESFJ - 执政官

**探险家（SP）：**
- ISTP - 鉴赏家
- ISFP - 探险家
- ESTP - 企业家
- ESFP - 表演者

## 🤖 第二步：部署自动化脚本

### 2.1 配置webhook地址

修改 `feishu_automation.js` 中的配置：

```javascript
const CONFIG = {
    // 更新为你的实际webhook地址
    WEBHOOK_URL: 'https://你的域名.com/hook',  // 替换为实际地址
    
    // 确保字段名称与表格完全一致
    FIELD_MAPPING: {
        nickname: '昵称',
        gender: '性别',
        // ... 其他字段
    }
};
```

### 2.2 部署到飞书自动化

1. **创建自动化流程**
   - 打开多维表格 → 自动化 → 创建新流程
   
2. **设置触发条件**
   - 选择："记录满足条件" 或 "手动触发"
   - 条件设置：所有必填字段已填写
   
3. **配置执行动作**
   - 选择："运行脚本"
   - 将 `feishu_automation.js` 的代码粘贴进去
   
4. **保存并启用**
   - 测试运行确认无误
   - 启用自动化流程

### 2.3 权限配置

确保你的飞书应用具有以下权限：

```
必需权限：
- bitable:app          # 多维表格操作
- im:message           # 发送私聊消息  
- im:resource          # 上传图片资源
- drive:file           # 文件读写（获取二维码）

可选权限：
- contact:user.id      # 通过邮箱查找用户
```

**权限申请步骤：**
1. 访问 https://open.feishu.cn/app/
2. 选择你的应用 → 权限管理
3. 搜索并添加上述权限
4. 提交审核（部分权限需要管理员批准）
5. 权限通过后，重新发布应用版本

## 🧪 第三步：测试验证

### 3.1 运行基础测试

使用提供的测试脚本验证功能：

```bash
# 运行完整测试流程
python test_bitable_workflow.py
```

### 3.2 飞书端测试

1. **字段配置测试**
   - 在多维表格开发者控制台运行 `quick_bitable_demo.js`
   - 验证所有字段配置正确

2. **工作流程测试**
   - 在表格中添加测试数据
   - 手动触发自动化流程
   - 检查名片生成和私聊通知

### 3.3 端到端测试

完整用户流程测试：

1. ✅ 用户填写完整信息 → 触发自动化
2. ✅ 系统生成名片 → 返回image_key
3. ✅ 用户收到私聊消息 → 可查看名片
4. ✅ 表格更新状态 → 显示名片链接

## 🔧 第四步：生产环境部署

### 4.1 服务器配置

如果使用云服务器部署：

```bash
# 安装依赖
pip install -r requirements.txt

# 设置环境变量
export FEISHU_APP_ID=你的应用ID
export FEISHU_APP_SECRET=你的应用密钥
export PORT=3001

# 启动服务
python app.py
```

### 4.2 域名配置

生产环境建议：
- 使用HTTPS域名（而非ngrok临时域名）
- 配置SSL证书
- 设置防火墙和安全策略

### 4.3 监控配置

```python
# 添加日志监控
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
    handlers=[
        logging.FileHandler('mbti_cards.log'),
        logging.StreamHandler()
    ]
)
```

## 📚 使用指南

### 管理员操作指南

1. **批量生成名片**
   - 选中多条记录 → 点击自动化按钮
   - 系统将依次处理所有选中记录

2. **状态监控**
   - 查看"生成状态"字段了解处理进度
   - 失败记录会显示"❌失败"状态

3. **重新生成**
   - 将状态改为"待生成" → 重新触发自动化

### 用户操作指南

1. **填写信息**
   - 完整填写所有必填字段
   - 上传清晰的微信二维码图片

2. **接收名片**
   - 生成完成后自动收到私聊通知
   - 点击消息查看完整名片

3. **获取链接**
   - 在表格"名片图片"字段查看访问链接
   - 支持分享和下载

## ❗ 故障排查

### 常见问题及解决方案

#### 1. 自动化无法触发

**现象：** 填写数据后没有自动生成名片

**排查步骤：**
- 检查自动化流程是否启用
- 确认触发条件设置正确
- 查看自动化执行日志

**解决方案：**
```javascript
// 在脚本中添加调试信息
console.log('触发条件检查:', {
    nickname: fields.昵称,
    mbti: fields.MBTI类型,
    triggerReady: !!(fields.昵称 && fields.MBTI类型)
});
```

#### 2. webhook调用失败

**现象：** 自动化运行但返回错误

**排查步骤：**
- 检查webhook地址是否正确
- 确认服务器是否在线
- 查看网络连接状态

**解决方案：**
```javascript
// 添加错误处理
try {
    const response = await fetch(WEBHOOK_URL, {...});
    if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
    }
} catch (error) {
    console.error('Webhook调用失败:', error);
    // 更新记录状态为失败
}
```

#### 3. 权限不足

**现象：** 返回403权限错误

**解决方案：**
1. 检查应用权限配置
2. 重新发布应用版本  
3. 等待权限审核通过

#### 4. 图片无法显示

**现象：** 名片链接打不开

**排查步骤：**
- 检查服务器是否正常运行
- 确认图片文件是否存在
- 测试网络连通性

**解决方案：**
```bash
# 检查服务状态
curl -I https://你的域名.com/healthz

# 检查图片访问
curl -I https://你的域名.com/image/xxx.png
```

#### 5. 微信二维码获取失败

**现象：** 生成的名片没有二维码

**排查步骤：**
- 检查附件字段是否有文件
- 确认文件格式是否为图片
- 查看飞书文件权限

**解决方案：**
- 重新上传清晰的二维码图片
- 确认图片格式为PNG/JPG
- 检查文件大小（建议<5MB）

## 🎉 完成检查清单

部署完成后，请确认以下项目：

### 基础配置
- [ ] 多维表格字段创建完成
- [ ] MBTI类型选项配置完成
- [ ] 自动化脚本部署完成
- [ ] webhook地址配置正确

### 权限配置
- [ ] 飞书应用权限申请完成
- [ ] 应用已重新发布
- [ ] 权限审核通过

### 功能测试
- [ ] 基础API测试通过
- [ ] 单条记录生成测试通过
- [ ] 批量生成测试通过
- [ ] 私聊消息发送正常
- [ ] 图片链接访问正常

### 生产环境
- [ ] 服务器稳定运行
- [ ] HTTPS域名配置
- [ ] 日志监控配置
- [ ] 备份策略配置

## 📞 技术支持

如果遇到问题，可以：

1. **查看日志**
   - 服务器端：检查 `mbti_cards.log`
   - 飞书端：打开开发者控制台

2. **运行测试**
   - 使用 `test_bitable_workflow.py` 进行完整测试
   - 使用 `quick_bitable_demo.js` 进行快速验证

3. **常用调试命令**
   ```bash
   # 检查服务状态
   python test_bitable_workflow.py
   
   # 手动测试单个用户
   curl -X POST https://你的域名.com/hook \\
     -H "Content-Type: application/json" \\
     -d '{"nickname":"测试","mbti":"ENFP"}'
   ```

---

**🎊 恭喜！你已经完成了飞书多维表格MBTI名片生成系统的完整部署！**

现在用户可以享受从填写问卷到获得个性化名片的完整自动化体验了。