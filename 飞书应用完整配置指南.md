# 🤖 飞书应用完整配置指南

**目标**: 解决飞书图片上传和自动消息发送的所有配置问题

## 🔍 问题诊断历程

### 已解决的问题 ✅
1. **99991672** - 权限不足 → ✅ 已获得 `im:resource` 权限  
2. **234001** - 参数格式错误 → ✅ 已修复 `image_type` 参数位置
3. **数据格式** - webhook兼容性 → ✅ 支持 multipart/form-data

### 当前问题 🔄  
**234007** - App does not enable bot feature
- **原因**: 飞书应用未启用机器人功能
- **影响**: 无法上传图片、无法发送消息
- **优先级**: 高（影响完整功能）

## 🚀 飞书应用配置步骤

### 步骤1: 启用机器人功能

#### 1.1 进入应用管理
1. 访问 https://open.feishu.cn/app/
2. 选择您的应用
3. 进入 **应用功能** → **机器人** 页面

#### 1.2 启用机器人
1. 点击 **启用机器人**
2. 配置机器人基本信息：
   ```
   机器人名称: 名片生成助手
   描述: 自动生成和发送个人名片  
   头像: 上传一个合适的头像图片
   ```
3. 点击 **保存**

### 步骤2: 配置应用权限

#### 2.1 必需权限清单
进入 **权限管理** 页面，添加以下权限：

**图片和文件权限**:
- ✅ `im:resource` - 获取图片、文件等资源  
- ✅ `im:resource:upload` - 上传图片、文件等资源

**消息发送权限**:
- ✅ `im:message` - 读取用户发给机器人的单聊消息  
- ✅ `im:message:send_as_bot` - 以应用的身份发消息

**用户信息权限** (可选):
- `contact:user.id:read` - 通过手机号或邮箱获取用户 user_id

#### 2.2 权限申请
1. 勾选所需权限
2. 填写权限申请理由：
   ```
   名片生成应用需要：
   1. 上传生成的名片图片到飞书 (im:resource:upload)
   2. 获取图片资源用于显示 (im:resource) 
   3. 自动发送名片给用户 (im:message:send_as_bot)
   4. 接收用户消息进行互动 (im:message)
   ```
3. 提交申请并等待审核

### 步骤3: 配置事件订阅 (可选)

如需支持更丰富的交互，可配置事件订阅：

#### 3.1 事件配置
1. 进入 **事件订阅** 页面
2. 配置 **请求网址**: `https://your-ngrok-url.ngrok-free.app/hook`
3. 订阅事件类型：
   - `im.message.receive_v1` - 接收消息事件

### 步骤4: 发布应用

#### 4.1 应用发布
1. 进入 **版本管理与发布** 页面  
2. 创建版本：
   ```
   版本号: 1.0.0
   版本说明: 名片生成机器人首个版本
   - 支持多维表格webhook触发
   - 自动生成个人名片
   - 支持图片上传和消息发送
   ```
3. 提交审核

#### 4.2 应用范围
选择应用可用范围：
- **仅本企业**: 推荐用于内部使用
- **公开应用**: 需要更严格的审核

## 🔧 技术配置

### 环境变量配置
```bash
# 在 ~/.bashrc 或 .zshrc 中添加
export FEISHU_APP_ID="cli_your_app_id"
export FEISHU_APP_SECRET="your_app_secret"
```

### 验证配置
```bash
# 重新加载环境变量
source ~/.bashrc

# 验证配置
echo $FEISHU_APP_ID
echo $FEISHU_APP_SECRET
```

## 📋 配置检查清单

### 基础配置 ☑️
- [ ] 应用已创建
- [ ] 机器人功能已启用  
- [ ] APP_ID 和 APP_SECRET 已配置
- [ ] 环境变量已设置

### 权限配置 ☑️  
- [ ] `im:resource` 权限已申请并通过
- [ ] `im:resource:upload` 权限已申请并通过
- [ ] `im:message:send_as_bot` 权限已申请并通过
- [ ] 权限状态显示为"已开通"

### 应用发布 ☑️
- [ ] 应用版本已创建
- [ ] 应用已提交审核  
- [ ] 应用状态为"已发布"或"审核中"

### 功能测试 ☑️
- [ ] Token获取正常 (`get_tenant_access_token`)
- [ ] 图片上传成功 (返回 `image_key`)  
- [ ] 消息发送成功 (用户能收到名片)

## 🚨 常见问题排错

### 问题1: 234007 - Bot功能未启用
```
解决方案:
1. 进入应用 → 应用功能 → 机器人  
2. 点击"启用机器人"
3. 配置机器人信息并保存
```

### 问题2: 权限申请被拒绝
```
解决方案:
1. 详细说明使用场景和必要性
2. 提供具体的功能描述
3. 确保申请理由合理且详细
```

### 问题3: 应用审核不通过
```
解决方案:
1. 检查应用描述是否完整
2. 确保功能说明清晰
3. 提供必要的截图和文档
```

### 问题4: Token获取失败
```
解决方案:  
1. 检查APP_ID和APP_SECRET是否正确
2. 确认应用状态为"已发布"
3. 验证环境变量配置
```

## 🎯 配置验证

### 完整测试命令
```bash
# 测试基础功能
curl -X POST "https://your-ngrok-url.ngrok-free.app/hook" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "配置测试",
    "title": "系统管理员",
    "company": "测试公司",  
    "email": "test@company.com"
  }'
```

### 预期成功响应
```json
{
  "status": "ok",
  "image_key": "img_v2_041b28e3-xxxx-xxxx", // 不再为null
  "image_url": "https://xxx.ngrok-free.app/image/xxx.png",
  "send_result": {
    // 不再是warn，而是成功消息
    "message_id": "om_xxx"
  }
}
```

## 📊 配置状态跟踪

### 当前状态
```
✅ 数据格式支持: multipart/form-data  
✅ API参数格式: image_type作为form字段
✅ 权限申请: im:resource权限已获得
🔄 机器人功能: 需要手动启用
🔄 完整权限: 需要im:resource:upload等
🔄 应用发布: 需要创建并发布版本
```

### 下一步行动
1. **立即执行**: 启用机器人功能  
2. **权限申请**: 补充缺失的权限
3. **应用发布**: 创建版本并发布
4. **功能测试**: 验证完整流程

## 💡 最佳实践建议

### 开发阶段
- 使用测试环境进行配置验证
- 保留详细的错误日志用于排错  
- 逐步启用功能，分步骤测试

### 生产部署  
- 确保所有权限审核通过
- 配置应用监控和日志
- 准备应急回退方案

### 用户体验
- 提供清晰的错误提示
- 支持多种名片获取方式
- 保持功能的向后兼容性

---

**🎯 配置完成后，您的飞书名片生成系统将实现**:
1. ✅ 接收飞书多维表格webhook  
2. ✅ 生成高质量名片图片
3. ✅ 上传图片到飞书获得image_key
4. ✅ 自动发送名片消息给用户
5. ✅ 提供多种图片访问方式

**立即行动**: 按照本指南逐步完成飞书应用配置，实现完整的自动化名片生成体验！