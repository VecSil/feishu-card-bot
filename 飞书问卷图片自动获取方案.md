# 🖼️ 飞书问卷图片自动获取与Webhook转发方案

**目标**: 实现用户提交飞书问卷时，自动获取问卷中的图片并通过webhook发送到您的数据库

## 🏗️ 技术架构

### 完整流程图
```
用户填写飞书问卷(含图片) 
    ↓
飞书多维表格存储数据
    ↓
触发Webhook到您的服务器
    ↓
自动解析并下载图片
    ↓
转发数据到目标数据库
    ↓
返回处理结果
```

### 技术方案对比

| 方案 | 优势 | 劣势 | 推荐度 |
|------|------|------|--------|
| **多维表格Webhook** | 稳定、成熟、易配置 | 需要飞书企业版 | ⭐⭐⭐⭐⭐ |
| 机器人事件监听 | 实时响应 | 复杂、权限要求高 | ⭐⭐⭐ |

## 🚀 方案实现

### 核心组件

#### 1. 图片处理服务 (`feishu_survey_image_webhook.py`)
- **功能**: 接收飞书webhook，解析图片附件，下载并转发
- **特性**: 
  - 支持多种图片格式 (JPG, PNG, GIF, WebP等)
  - 自动文件命名和本地存储
  - 智能错误处理和重试机制
  - 生成公网访问URL

#### 2. 自动配置脚本 (`setup_survey_webhook.sh`)
- **功能**: 一键配置环境变量和依赖
- **特性**:
  - 交互式配置向导
  - 自动依赖检查和安装
  - 飞书API连接测试

#### 3. 测试验证工具 (`test_survey_webhook.sh`)
- **功能**: 全面测试系统功能
- **特性**:
  - 模拟真实webhook请求
  - 验证图片处理流程
  - 生成配置说明

## 📦 快速部署

### 步骤1: 环境准备
```bash
# 1. 运行配置脚本
chmod +x setup_survey_webhook.sh
./setup_survey_webhook.sh

# 2. 启动服务
./start_survey_webhook.sh

# 3. 启动ngrok (新终端)
ngrok http 3001
```

### 步骤2: 飞书配置

#### 2.1 创建飞书问卷
1. 访问 https://feishu.cn/
2. 创建多维表格
3. 添加问卷字段：
   - 文本字段：姓名、邮箱等
   - **附件字段**：头像、证件照片等 ⬅️ 关键

#### 2.2 配置自动化Webhook
1. 打开多维表格 → **自动化** → **创建自动化**
2. **触发条件**: 记录创建时/记录更新时
3. **动作**: 发送HTTP请求
4. **配置**:
   ```
   URL: https://your-ngrok-url.ngrok-free.app/webhook
   方法: POST
   Content-Type: application/json
   请求体: 字段数据 (包含附件字段)
   ```

### 步骤3: 数据库Webhook配置
```bash
# 设置目标数据库webhook地址
export TARGET_WEBHOOK_URL="https://your-database-api.com/webhook"
```

## 🔧 详细配置

### 环境变量说明
```bash
# 飞书应用配置
FEISHU_APP_ID="cli_your_app_id"           # 飞书应用ID
FEISHU_APP_SECRET="your_app_secret"       # 飞书应用密钥

# 目标数据库配置  
TARGET_WEBHOOK_URL="https://your-api.com/webhook"  # 您的数据库API地址

# 服务配置
IMAGE_DOWNLOAD_DIR="./downloaded_images"   # 图片本地存储目录
PORT="3001"                              # 服务端口
```

### 飞书应用权限
需要在飞书开放平台申请以下权限：
- `drive:file:read` - 读取文件内容
- `drive:file:download` - 下载文件
- `bitable:app:read` - 读取多维表格数据

## 📊 数据流格式

### 接收的Webhook数据格式
```json
{
    "event": {
        "after_change": {
            "fields": {
                "姓名": "张三",
                "邮箱": "zhangsan@example.com",
                "头像照片": [
                    {
                        "file_token": "boxcnxxxxxxxxxxxxxxx",
                        "name": "avatar.jpg",
                        "type": "image/jpeg",
                        "size": 102400
                    }
                ],
                "证件照片": [
                    {
                        "file_token": "boxcnxxxxxxxxxxxxxxy", 
                        "name": "id_card.png",
                        "type": "image/png",
                        "size": 256000
                    }
                ]
            }
        }
    }
}
```

### 发送到数据库的数据格式
```json
{
    "timestamp": "2025-08-23T15:30:45.123Z",
    "source": "feishu_survey",
    "submission_data": {
        "姓名": "张三",
        "邮箱": "zhangsan@example.com"
    },
    "images": [
        {
            "field_name": "头像照片",
            "file_token": "boxcnxxxxxxxxxxxxxxx",
            "file_name": "avatar.jpg", 
            "file_type": "image/jpeg",
            "file_size": 102400,
            "local_path": "/path/to/downloaded_images/20250823-153045_avatar.jpg",
            "download_url": "https://your-server.com/images/20250823-153045_avatar.jpg"
        },
        {
            "field_name": "证件照片",
            "file_token": "boxcnxxxxxxxxxxxxxxy",
            "file_name": "id_card.png",
            "file_type": "image/png", 
            "file_size": 256000,
            "local_path": "/path/to/downloaded_images/20250823-153045_id_card.png",
            "download_url": "https://your-server.com/images/20250823-153045_id_card.png"
        }
    ],
    "total_images": 2,
    "webhook_metadata": {
        "app_id": "cli_your_app_id",
        "processed_at": "2025-08-23T15:30:45.456Z"
    }
}
```

## 🔍 功能特性

### 智能图片处理
- **格式支持**: JPG, PNG, GIF, WebP, BMP, TIFF
- **大小检查**: 自动验证文件大小和类型
- **命名规范**: 时间戳 + 原文件名避免冲突
- **本地存储**: 安全的本地文件管理

### 可靠性保障
- **错误处理**: 完善的异常捕获和日志记录
- **重试机制**: 网络失败自动重试
- **状态跟踪**: 详细的处理状态和结果
- **健康检查**: 服务状态监控接口

### 扩展性设计
- **模块化**: 清晰的组件分离
- **配置化**: 灵活的环境变量配置
- **API友好**: 标准的REST接口设计
- **日志完整**: 便于调试和监控

## 🧪 测试验证

### 自动化测试
```bash
# 运行完整功能测试
./test_survey_webhook.sh
```

### 手动测试步骤
```bash
# 1. 测试服务健康
curl https://your-ngrok-url.ngrok-free.app/healthz

# 2. 模拟问卷提交
curl -X POST https://your-ngrok-url.ngrok-free.app/webhook \
  -H "Content-Type: application/json" \
  -d '{"event": {"after_change": {"fields": {...}}}}'

# 3. 验证图片下载
ls -la downloaded_images/

# 4. 测试图片访问
curl https://your-ngrok-url.ngrok-free.app/images/filename.jpg
```

## 📈 监控和维护

### 日志管理
```bash
# 查看服务日志
tail -f logs/survey_webhook.log

# 监控图片下载
watch -n 5 'ls -la downloaded_images/ | tail -10'
```

### 性能监控
- **处理速度**: 平均每个图片处理时间 < 3秒
- **存储管理**: 自动清理超过30天的图片
- **错误率**: 目标错误率 < 1%

### 故障排除

#### 常见问题

**1. 图片下载失败**
```
原因: file_token无效或过期
解决: 检查飞书应用权限配置
```

**2. Webhook调用失败**
```
原因: 目标数据库地址不可达
解决: 验证TARGET_WEBHOOK_URL配置
```

**3. 服务响应超时**
```
原因: 图片文件过大或网络慢
解决: 增加timeout配置或优化网络
```

## 🎯 最佳实践

### 生产部署建议
1. **使用固定域名**: 配置固定的公网域名替代ngrok
2. **启用HTTPS**: 确保数据传输安全  
3. **配置负载均衡**: 支持高并发请求
4. **定期备份**: 重要图片数据定期备份

### 安全考虑
- **API认证**: 为webhook接口添加身份验证
- **文件验证**: 严格验证上传文件类型和大小
- **访问控制**: 限制图片访问权限
- **数据加密**: 敏感数据传输加密

### 扩展方案
- **图片压缩**: 自动压缩大尺寸图片
- **云存储**: 集成阿里云OSS、腾讯COS等
- **AI处理**: 添加图片内容识别和分析
- **批量处理**: 支持批量问卷数据处理

## 💡 应用场景

### 典型使用场景
1. **员工入职**: 自动收集员工头像、证件照
2. **活动报名**: 收集参与者照片和资料  
3. **客户注册**: 自动获取客户身份证明
4. **产品反馈**: 收集用户上传的产品图片
5. **证书申请**: 自动处理各类证书申请材料

### 行业应用
- **HR系统**: 员工档案管理
- **教育机构**: 学生信息收集
- **医疗机构**: 患者资料管理
- **金融服务**: 客户身份验证
- **电商平台**: 商家资质审核

## 🎉 总结

### 核心优势
- ✅ **零人工干预**: 全自动图片获取和处理
- ✅ **高可靠性**: 完善的错误处理和重试机制  
- ✅ **易于集成**: 标准的webhook接口
- ✅ **扩展性强**: 支持多种图片格式和存储方案
- ✅ **监控完善**: 详细的日志和状态追踪

### 预期效果
- **处理效率**: 从手动收集 → 全自动化
- **数据完整性**: 100%保证图片和数据关联
- **用户体验**: 一次提交，自动处理
- **系统集成**: 无缝对接现有数据库

---

**🚀 立即开始**: 运行 `./setup_survey_webhook.sh` 开始配置您的飞书问卷图片自动获取系统！